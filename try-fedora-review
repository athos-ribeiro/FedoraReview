#!/usr/bin/python -tt
#-*- coding: utf-8 -*-
# vim: set expandtab: ts=4:sw=4:
#
# Script to run a fedora-review installation from wherever it is
# located. Primarily intended to be able to run a test version
# in parallel with the official one.
#
# Usage:
#     $ ln -s $PWD/try-fedora-review ~/bin
#     $ try-fedora-review <args>
#
# (C) 2011 - Alec Leamas

import os
import os.path
import sys
import subprocess

main_dir = os.path.dirname(os.path.realpath(__file__))
pkg_dir = os.path.join(main_dir, 'src')
sys.path.insert(1, pkg_dir)

from FedoraReview.review_helper import ReviewHelper
try:
    from subprocess import check_output
except ImportError:
    from FedoraReview.el_compat import check_output


def _link_hook(source, hook):
    ''' Symlink source to a git hook, fail silently. '''
    try:
        main_dir = os.path.dirname(os.path.realpath(__file__))
        os.symlink(source, os.path.join(main_dir, '.git/hooks', hook))
    except OSError:
        pass


# let's setup a proper git commit hooks so people don't commit ugly code
# accidentally
_link_hook('../../update-version', 'post-commit')
_link_hook('../../git-hooks/pre-commit', 'pre-commit')

review = ReviewHelper()
review.run()

os.chdir(main_dir)
cmd = ["git", "rev-parse", "--abbrev-ref", "HEAD"]
cur_branch = check_output(cmd).strip()
if cur_branch == "master":
    print "\033[91mYou are running fedora-review from 'master' branch. This " \
          "is probably not what you want to do. Master branch is equal to " \
          "latest stable release. For development/bugreporting use " \
          "'devel' branch. See CONTRIBUTE file for more details\033[0m"
